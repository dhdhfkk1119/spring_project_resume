{{> layout/header}}

<div class="container my-5" style="max-with:1200px;">
    <div class="card shadow-sm">
        <div class="card-header bg-light py-3">
            <!-- 양쪽으로 정렬하기 위해 d-flex 적용 -->
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">{{member.username}}님의 이력서 업그레이드 중</h2>
                <!-- 삭제 아이콘 버튼과 form -->
                <form id="delete-form-icon" action="/resume/{{resume.resumeIdx}}/delete" method="post">
                    <button type="submit" class="btn btn-link p-0" title="삭제하기" style="color: Tomato;">
                        <i class="fa-solid fa-trash fs-5"></i>
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            <form id="update-form" action="/resume/{{resume.resumeIdx}}/update" method="post">
                <!-- 이력서 제목 -->
                <div class="mb-3">
                    <label for="resumeTitle" class="form-label fw-bold">눈길을 잡아끄는 한 문장</label>
                    <input type="text" class="form-control" id="resumeTitle" name="resumeTitle"
                           value="{{resume.resumeTitle}}" maxlength="50" required>
                    {{#errors.resumeTitle}}
                        <div class="text-danger small">{{.}}</div>{{/errors.resumeTitle}}
                </div>
                <!-- 이력서 본문 -->
                <div class="mb-3">
                    <label for="resumeContent" class="form-label fw-bold">마음을 움직이는 소개글</label>
                    <textarea class="form-control" id="resumeContent" name="resumeContent"
                              rows="10" maxlength="5000" required>{{resume.resumeContent}}</textarea>
                    {{#errors.resumeContent}}
                        <div class="text-danger small">{{.}}</div>{{/errors.resumeContent}}
                </div>
                <!-- 대표 이력서 설정 체크박스 -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" name="isRep" id="isRep" value="true"
                           {{#resume.isRep}}checked{{/resume.isRep}}>
                    <label class="form-check-label" for="isRep">
                        이 이력서를 내 대표 이력서로 설정할게요
                    </label>
                </div>

                <hr>

                <h4>경력 정보</h4>
                <div id="career-container" data-initial-size="{{resume.careerList.size}}">
                    {{#resume.careerList}}
                        <div class="card my-3 p-3 bg-light career-item">
                            <div class="row">
                                <div class="col-md-11">
                                    <h5 class="card-title">{{corpName}}</h5>
                                    {{#position}}
                                        <h6 class="card-subtitle mb-2 text-muted">{{position}}</h6>
                                    {{/position}}

                                    {{#startAt}}
                                        {{#endAt}}
                                            <p class="card-text"><small class="text-muted">{{startAt}} ~ {{endAt}}</small></p>
                                        {{/endAt}}
                                        {{^endAt}}
                                            <p class="card-text"><small class="text-muted">{{startAt}} ~</small></p>
                                        {{/endAt}}
                                    {{/startAt}}
                                    <p class="card-text" style="white-space: pre-wrap;">{{careerContent}}</p>
                                </div>
                                <div class="col-md-1 d-flex align-items-center justify-content-center">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-career-btn"
                                            data-career-id="{{careerIdx}}">삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    {{/resume.careerList}}
                </div>
                <button type="button" id="add-career-btn" class="btn btn-outline-secondary">경력 추가</button>

                <hr>
                <div class="d-flex justify-content-end">
                    <a href="/resume/{{resume.resumeIdx}}" class="btn btn-outline-secondary me-2">취소</a>
                    <button type="button" id="submit-btn" class="btn btn-outline-primary">수정완료</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const careerContainer = document.getElementById('career-container');
        const addCareerBtn = document.getElementById('add-career-btn');
        const updateForm = document.getElementById('update-form');
        const submitBtn = document.getElementById('submit-btn');

        const initialSize = careerContainer.getAttribute('data-initial-size');
        let careerIndex = initialSize ? parseInt(initialSize, 10) : 0;

        // 날짜 입력을 위한 flatpickr 초기화 함수
        function initializeFlatpickr(element) {
            flatpickr(element, {
                dateFormat: "Y-m-d", // 날짜 형식 지정 (YYYY-MM-DD)
                locale: "ko" // 한글 지원 (CDN 추가 필요 시)
            });
        }

        addCareerBtn.addEventListener('click', function () {
            const careerDiv = document.createElement('div');
            careerDiv.classList.add('card', 'my-3', 'p-3', 'bg-light', 'career-item', 'new-career-item');

            // 새로 추가되는 입력창에도 required 속성을 추가하여 빈 값 제출을 방지합니다.
            careerDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-11">
                        <div class="mb-2">
                            <label class="form-label">회사명</label>
                            <input type="text" name="careers[${careerIndex}].corpName" class="form-control"
                                                         value="좋좋소"
                            maxlength="50" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">직책</label>
                            <input type="text" name="careers[${careerIndex}].position" class="form-control"
                            value="과장대리"
                            maxlength="50">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">담당 업무</label>
                            <input type="text" name="careers[${careerIndex}].careerContent" class="form-control"
                             value="복사와 커피타기"
                             maxlength="500" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">입사일</label>
                                <input type="date" name="careers[${careerIndex}].startAt" class="form-control"
                                value="2022-02-22">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">퇴사일</label>
                                <input type="date" name="careers[${careerIndex}].endAt" class="form-control"
                                value="2022-02-22">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1 d-flex align-items-center justify-content-center">
                        <button type="submit" class="btn btn-link p-0" title="삭제하기" style="color: Tomato;">
                            <i class="fa-solid fa-trash fs-5"></i>
                        </button>
                    </div>
                </div>
            `;
            careerContainer.appendChild(careerDiv);

            // 날짜 input에 flatpickr 적용
            const newDateInputs = careerDiv.querySelectorAll('input[type="date"]');
            newDateInputs.forEach(initializeFlatpickr);

            careerIndex++;

        });

        // 페이지 로드 시 이미 존재하는 날짜 input에 적용 (update 페이지용)
        const existingDateInputs = document.querySelectorAll('input[type="date"]');
        existingDateInputs.forEach(initializeFlatpickr);

        careerContainer.addEventListener('click', function (e) {
            if (e.target && e.target.classList.contains('remove-career-btn')) {
                const careerItem = e.target.closest('.career-item');
                if(careerItem) {
                    const careerId = e.target.getAttribute('data-career-id');
                    if (careerId) {
                        careerItem.style.display = 'none';
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.name = 'deletedCareerIds';
                        hiddenInput.value = careerId;
                        careerItem.appendChild(hiddenInput);
                    } else {
                        careerItem.remove();
                    }
                }
            }
        });

        submitBtn.addEventListener('click', function() {
            // [수정] 폼을 강제로 제출하기 전에, 비어있는 '유령' 경력창을 먼저 정리합니다.
            const newCareerItems = document.querySelectorAll('.new-career-item');
            newCareerItems.forEach(item => {
                const corpNameInput = item.querySelector('input[name*="corpName"]');
                if (corpNameInput && corpNameInput.value.trim() === '') {
                    item.remove();
                }
            });

            // [수정] 폼의 유효성을 브라우저가 직접 검사하도록 합니다.
            if (updateForm.checkValidity()) {
                // 모든 required 필드가 채워졌으면 폼을 제출합니다.
                updateForm.submit();
            } else {
                // 채워지지 않은 필드가 있으면, 브라우저가 사용자에게 경고 메시지를 보여줍니다.
                updateForm.reportValidity();
            }
        });

        // 삭제 버튼 ( 휴지통 )
        const deleteFormIcon = document.getElementById('delete-form-icon');
        if (deleteFormIcon) {
            deleteFormIcon.addEventListener('submit', function(event) {
                if (!confirm('정말로 이 이력서를 삭제하시겠습니까?')) {
                    event.preventDefault();
                }
            });
        }
    });
</script>

{{> layout/footer}}
